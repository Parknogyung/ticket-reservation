syntax = "proto3";

// 패키지 명은 본인의 프로젝트 구조에 맞게 수정하세요.
package com.ticket.portfolio;

// [Java 옵션] 이 설정들이 있어야 자바 파일이 예쁘게 생성됩니다.
option java_multiple_files = true; // 클래스 파일을 각각 분리해서 생성
option java_package = "com.ticket.portfolio"; // 자바 패키지 경로
option java_outer_classname = "TicketProto"; // 전체를 감싸는 클래스명

// ------------------------------------------------------------
// 1. 서비스 정의 (API 명세)
// ------------------------------------------------------------
service TicketService {
  // ① 대기열 토큰 발급 (대기표 뽑기)
  rpc IssueToken (TokenRequest) returns (TokenResponse);

  // ② 예약 가능한 좌석 조회
  rpc GetAvailableSeats (SeatSearchRequest) returns (SeatListResponse);

  // ③ 좌석 예약 요청 (핵심: 동시성 제어 필요)
  rpc ReserveSeat (ReservationRequest) returns (ReservationResponse);

  // ④ 로그인 (gRPC 인증용)
  rpc Login (LoginRequest) returns (LoginResponse);

  // ⑤ 티켓(콘서트) 등록 (Admin용)
  rpc RegisterConcert (RegisterConcertRequest) returns (RegisterConcertResponse);

  // ⑥ 티켓(콘서트) 목록 조회
  rpc GetConcerts (GetConcertsRequest) returns (ConcertListResponse);
  // ⑦ 예약 확정 (결제 완료 후 호출)
  rpc CompleteReservation (CompleteReservationRequest) returns (CompleteReservationResponse);
}

service PaymentService {
  rpc ProcessPayment (PaymentRequest) returns (PaymentResponse);
}

// ------------------------------------------------------------
// 2. 메시지 정의 (DTO)
// ------------------------------------------------------------

// --- ① 대기열 관련 메시지 ---
message TokenRequest {
  string user_id = 1;     // 사용자 ID (UUID 등)
  int64 concert_id = 2;   // 공연 ID
}

message TokenResponse {
  string token = 1;       // 발급된 대기열 토큰 (JWT 혹은 UUID)
  int64 wait_position = 2;// 내 앞의 대기 인원 수
  int64 estimated_wait_seconds = 3; // 예상 대기 시간(초)
  bool can_enter = 4;     // 즉시 입장 가능 여부
}

// --- ② 좌석 조회 관련 메시지 ---
message SeatSearchRequest {
  string token = 1;       // [보안] 대기열 토큰
  int64 concert_id = 2;   // 공연 ID
}

message Seat {
  int64 seat_id = 1;      // 좌석 고유 ID
  int32 seat_number = 2;  // 좌석 번호
  string status = 3;      // 상태 (AVAILABLE, RESERVED, SOLD)
}

message SeatListResponse {
  repeated Seat seats = 1;
}

// --- ③ 예약 관련 메시지 ---
message ReservationRequest {
  string token = 1;       // [보안] 대기열 토큰
  string user_id = 2;     // 사용자 ID
  int64 seat_id = 3;      // 예약하려는 좌석 ID
}

message ReservationResponse {
  bool success = 1;       // 성공 여부 (true/false)
  string message = 2;     // 결과 메시지
  int64 reservation_id = 3;
}

// --- ④ 로그인 관련 메시지 ---
message LoginRequest {
  string email = 1;
  string password = 2;
}

message LoginResponse {
  bool success = 1;
  string access_token = 2;
  string refresh_token = 3;
  string message = 4;
  int64 user_id = 5;
}

// --- ⑤ 티켓 등록 관련 메시지 ---
message RegisterConcertRequest {
  string title = 1;
  int32 seat_count = 2;
  string concert_date = 3; // yyyy-MM-dd HH:mm:ss
}

message RegisterConcertResponse {
  bool success = 1;
  string message = 2;
  int64 concert_id = 3;
}

// --- ⑥ 티켓 목록 조회 관련 메시지 ---
message GetConcertsRequest {
}

message ConcertInfo {
  int64 concert_id = 1;
  string title = 2;
  string concert_date = 3;
  int32 available_seats = 4;
}

message ConcertListResponse {
  repeated ConcertInfo concerts = 1;
}

// --- ⑦ 예약 확정 관련 메시지 ---
message CompleteReservationRequest {
  string user_id = 1;
  int64 reservation_id = 2;
  string payment_id = 3;
}

message CompleteReservationResponse {
  bool success = 1;
  string message = 2;
}

// --- ⑧ 결제 관련 메시지 ---
message PaymentRequest {
  string user_id = 1;
  int64 reservation_id = 2;
  int64 amount = 3;
  string payment_id = 4;
}

message PaymentResponse {
  bool success = 1;
  string message = 2;
  string transaction_id = 3;
}