syntax = "proto3";

import "google/protobuf/empty.proto";

// 패키지 명은 본인의 프로젝트 구조에 맞게 수정하세요.
package com.ticket.portfolio;

// [Java 옵션] 이 설정들이 있어야 자바 파일이 예쁘게 생성됩니다.
option java_multiple_files = true; // 클래스 파일을 각각 분리해서 생성
option java_package = "com.ticket.portfolio"; // 자바 패키지 경로
option java_outer_classname = "TicketProto"; // 전체를 감싸는 클래스명

// ------------------------------------------------------------
// 1. 서비스 정의 (API 명세)
// ------------------------------------------------------------
service TicketService {
  // ① 대기열 토큰 발급 (대기표 뽑기)
  rpc IssueToken (TokenRequest) returns (TokenResponse);

  // ② 예약 가능한 좌석 조회
  rpc GetAvailableSeats (SeatSearchRequest) returns (SeatListResponse);

  // ③ 좌석 예약 요청 (핵심: 동시성 제어 필요)
  rpc ReserveSeat (ReservationRequest) returns (ReservationResponse);

  // ④ 로그인 (gRPC 인증용)
  rpc Login (LoginRequest) returns (LoginResponse);

  // ⑤ 티켓(콘서트) 등록 (Admin용)
  rpc RegisterConcert (RegisterConcertRequest) returns (RegisterConcertResponse);

  // ⑥ 티켓(콘서트) 목록 조회
  rpc GetConcerts (GetConcertsRequest) returns (ConcertListResponse);
  // ⑦ 예약 확정 (결제 완료 후 호출)
  rpc CompleteReservation (CompleteReservationRequest) returns (CompleteReservationResponse);
  // ⑧ 예약 취소/환불 (PaymentService에서 호출)
  rpc RefundReservation (RefundReservationRequest) returns (RefundReservationResponse);
  // ⑨ 내 예약 목록 조회
  rpc GetMyReservations (GetMyReservationsRequest) returns (MyReservationListResponse);
  
  // ⑩ 예약 상세 조회 (결제 화면용)
  rpc GetReservationDetails (GetReservationDetailsRequest) returns (GetReservationDetailsResponse);
  
  // ⑪ 이메일로 사용자 조회 (소셜 로그인용)
  rpc GetUserByEmail (GetUserByEmailRequest) returns (GetUserByEmailResponse);
  
  // ⑫ Debug: 대기열 강제 채우기
  rpc DebugFillQueue (DebugFillQueueRequest) returns (DebugFillQueueResponse);
}

service PaymentService {
  rpc ProcessPayment (PaymentRequest) returns (PaymentResponse);
  rpc CancelPayment (CancelPaymentRequest) returns (CancelPaymentResponse);
}

// ------------------------------------------------------------
// 2. 메시지 정의 (DTO)
// ------------------------------------------------------------

// --- ① 대기열 관련 메시지 ---
message TokenRequest {
  string user_id = 1;     // 사용자 ID (UUID 등)
  int64 concert_id = 2;   // 공연 ID
}

message TokenResponse {
  string token = 1;       // 발급된 대기열 토큰 (JWT 혹은 UUID)
  int64 wait_position = 2;// 내 앞의 대기 인원 수
  int64 estimated_wait_seconds = 3; // 예상 대기 시간(초)
  bool can_enter = 4;     // 즉시 입장 가능 여부
}

// --- ② 좌석 조회 관련 메시지 ---
message SeatSearchRequest {
  string token = 1;       // [보안] 대기열 토큰
  int64 concert_id = 2;   // 공연 ID
}

message Seat {
  int64 seat_id = 1;      // 좌석 고유 ID
  int32 seat_number = 2;  // 좌석 번호
  string status = 3;      // 상태 (AVAILABLE, RESERVED, SOLD)
}

message SeatListResponse {
  repeated Seat seats = 1;
  bool queue_active = 2; // 대기열 활성화 여부
}

// --- ③ 예약 관련 메시지 ---
message ReservationRequest {
  string token = 1;       // [보안] 대기열 토큰
  string user_id = 2;     // 사용자 ID
  repeated int64 seat_ids = 3; // 예약하려는 좌석 IDs
}

message ReservationResponse {
  bool success = 1;       // 성공 여부 (true/false)
  string message = 2;     // 결과 메시지
  repeated int64 reservation_ids = 3;
}

// --- ④ 로그인 관련 메시지 ---
message LoginRequest {
  string email = 1;
  string password = 2;
}

message LoginResponse {
  bool success = 1;
  string access_token = 2;
  string refresh_token = 3;
  string message = 4;
  int64 user_id = 5;
}

// --- ⑤ 티켓 등록 관련 메시지 ---
message RegisterConcertRequest {
  string title = 1;
  int32 seat_count = 2;
  string concert_date = 3; // yyyy-MM-dd HH:mm:ss
  int64 price = 4;
}

message RegisterConcertResponse {
  bool success = 1;
  string message = 2;
  int64 concert_id = 3;
}

// --- ⑥ 티켓 목록 조회 관련 메시지 ---
message GetConcertsRequest {
}

message ConcertInfo {
  int64 concert_id = 1;
  string title = 2;
  string concert_date = 3;
  int32 available_seats = 4;
  int64 price = 5;
}

message ConcertListResponse {
  repeated ConcertInfo concerts = 1;
}

// --- ⑦ 예약 확정 관련 메시지 ---
message CompleteReservationRequest {
  string user_id = 1;
  repeated int64 reservation_ids = 2;
  string payment_id = 3;
}

message CompleteReservationResponse {
  bool success = 1;
  string message = 2;
}

// --- ⑧ 결제 관련 메시지 ---
message PaymentRequest {
  string user_id = 1;
  repeated int64 reservation_ids = 2;
  int64 amount = 3;
  string payment_id = 4;
}

message PaymentResponse {
  bool success = 1;
  string message = 2;
  string transaction_id = 3;
}

message CancelPaymentRequest {
  string payment_id = 1;
  string reason = 2; // e.g. "Customer requested", "System error"
  repeated int64 reservation_ids = 3;
}

message CancelPaymentResponse {
  bool success = 1;
  string message = 2;
}

// --- ⑨ 예약 취소/환불 관련 메시지 ---
// TicketService가 PaymentService로부터 호출받아 예약 상태를 취소로 변경
message RefundReservationRequest {
  repeated int64 reservation_ids = 1;
}

message RefundReservationResponse {
  bool success = 1;
  string message = 2;
}

// --- ⑩ 내 예약 목록 조회 관련 메시지 ---
message GetMyReservationsRequest {
  string user_id = 1;
}

message MyReservationInfo {
  int64 reservation_id = 1;
  string concert_title = 2;
  string concert_date = 3;
  int32 seat_number = 4;
  string status = 5; // PENDING, CONFIRMED, CANCELLED
  int64 amount = 6;
  string payment_id = 7;
}

message MyReservationListResponse {
  repeated MyReservationInfo reservations = 1;
}

// --- ⑪ 예약 상세 조회 관련 메시지 ---
message GetReservationDetailsRequest {
  repeated int64 reservation_ids = 1;
}

message GetReservationDetailsResponse {
  string title = 1;
  int64 amount = 2; // price (Total)
  repeated int64 reservation_ids = 3;
}

// --- ⑪ 이메일로 사용자 조회 관련 메시지 ---
message GetUserByEmailRequest {
  string email = 1;
}

message GetUserByEmailResponse {
  int64 user_id = 1;
  string email = 2;
}

// --- ⑫ Debug 관련 메시지 ---
message DebugFillQueueRequest {
  int64 concert_id = 1;
  int32 count = 2; // 채울 인원 수
}

message DebugFillQueueResponse {
  bool success = 1;
  string message = 2;
  int64 current_count = 3;
}

// --------------------
// 12. Log Service (gRPC Streaming)
// --------------------
message LogMessage {
  string timestamp = 1;
  string level = 2;
  string logger_name = 3;
  string message = 4;
  string service_name = 5;
}

service LogStreamService {
  rpc StreamLogs (stream LogMessage) returns (google.protobuf.Empty);
}